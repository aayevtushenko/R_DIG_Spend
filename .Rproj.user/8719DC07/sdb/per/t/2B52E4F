{
    "collab_server" : "",
    "contents" : "# import files from dv, dcm and prisma and join them by using the pcodes. Then calculate the cost based on the cost method in prisma.\n# the scripts allow calculating single or multiple weekly spend\n# raw data are put in folder starts with \"data_for\"\n# output excel files are put into \"DIG\" folder\n\nlibrary(RDoubleClick) # package for dcm\nlibrary(stringr) # for string mainipulation\nlibrary(lubridate) # for date manipulation\nlibrary(dplyr) # for data cleaning\nlibrary(readr) # for reading files\nlibrary(readxl) # for reading xlsx files\nlibrary(openxlsx) # for writing excel files\n\n# DCN API: get access by using client.id and client.secret\nclient.id <- \"963284085963-6tehp3a30ovmjuk3v4bohg2t16no79pj.apps.googleusercontent.com\"\nclient.secret <- \"hwatT9yHYdTZBnoGgNCVBS2J\"\n\nDCAuth(client.id,client.secret,runwebserver = FALSE)\n\n# import double verify \ndv_homegoods <- read_csv(\"data_for_hg/dv_homegoods.csv\") %>% \n  mutate(Date = mdy(Date))\n\n# import prisma files\nprisma_homegood_1 <-read_excel(\"data_for_hg/prisma_homegood.xlsx\", sheet = \"q4\") %>% \n  mutate(p_code = substr(Name,1, 6), # get the pcode\n         `Flight start date` = ymd(`Flight start date`),\n         `Flight end date` = ymd(`Flight end date`),\n         flight_week_diff = abs(week(`Flight end date`) - week(`Flight start date`)))\n\nprisma_homegood_2 <-read_excel(\"data_for_hg/prisma_homegood.xlsx\", sheet = \"2h\") %>% \n  mutate(p_code = substr(Name,1, 6), # get the pcode\n         `Flight start date` = ymd(`Flight start date`),\n         `Flight end date` = ymd(`Flight end date`),\n         flight_week_diff = abs(week(`Flight end date`) - week(`Flight start date`)))\n\n## combine\nprisma_homegood <- rbind(prisma_homegood_2, prisma_homegood_1)\n\n\n## download DCM report, reports needs to be built on DCM site. ONly problems for this R package\ndcm_homegood_reports <-  files.get(fileId=635138357,reportId = 108705867)\n\ndcm_homegood_reports_cleaned <- dcm_homegood_reports %>% \n  mutate(p_code = substr(Placement,1, 6), # get the pcodes\n         Week = week(Date)) %>% \n  rename(\"DCM_clicks\" = Clicks,\n         \"DCM_impressions\" = Impressions) %>%  # rename columns\n  group_by(p_code, Week) %>%   # sum based on p_code and week (sumifs in excel)\n  summarise(DCM_clicks = sum(DCM_clicks),\n            DCM_impressions= sum(DCM_impressions)) %>% \n  select(Week,p_code,DCM_clicks,DCM_impressions) # keep relevant columns\n\n### double verify\ndv_homegood_cleaned <- dv_homegoods %>% \n  mutate(p_code = substr(`Placement Name`,1, 6), # get pcode\n         Week = week(Date)) %>% \n  select(`Campaign Name`,`Media Property`,`Placement Name`,Date,Week,p_code,`GroupM Billable Impressions`) %>% \n  group_by(p_code, Week) %>% \n  summarise(DV_impressions = sum(`GroupM Billable Impressions`))\n\n### combine dv and dcm\nhomegood_dcm_dc <- full_join(dcm_homegood_reports_cleaned,dv_homegood_cleaned, by = c(\"p_code\",\"Week\"))\n\n### prisma\nprisma_homegood_cleaned<-prisma_homegood %>% \n  select(p_code,Supplier, `Cost method` ,Rate, `Total Planned Cost`,\n         # oct_cost_by_week, \n         flight_week_diff)\n\n# loops to go combine homegood_dcm_dc and prisma_cleaned data based on the weeks in the former dataset. Only keep relevant pcodes' data that are \n#  present in prisma_cleaned data. Then calculate based on \"cost method\" column \n\nhomegood_dig_spend <- data.frame()\n\nfor(i in unique(homegood_dcm_dc$Week)){\n  homegood_dcm_dc_loop <- homegood_dcm_dc %>% \n    filter(Week == i) %>% \n    select(-Week)\n  \n  data <- left_join(prisma_homegood_cleaned, homegood_dcm_dc_loop, by = \"p_code\")%>% \n    mutate(DCM_clicks = ifelse(is.na(DCM_clicks),0,DCM_clicks),\n           DCM_impressions= ifelse(is.na(DCM_impressions),0,DCM_impressions),\n           DV_impressions= ifelse(is.na(DV_impressions),0,DV_impressions))%>% \n    mutate(Spend = case_when(`Cost method` == \"CPMV\" ~(DV_impressions/1000)*Rate,\n                             #`Cost method` == \"CPA\" ~ oct_cost_by_week,\n                             `Cost method` == \"Flat\" & DV_impressions >0 & flight_week_diff != 0 ~ `Total Planned Cost`/flight_week_diff,\n                             `Cost method` == \"Flat\" & DV_impressions >0 & flight_week_diff == 0 ~ `Total Planned Cost`,\n                             `Cost method` == \"Flat\" & DV_impressions <= 0 ~ 0,\n                             `Cost method` == \"Free\" ~ 0))\n  data_spend <- data %>% \n    group_by(Supplier) %>% \n    summarise(Spend = sum(Spend)) \n  \n  data_spend$Week <- i\n  \n  data_spend %>% \n    select(Week,Supplier,Spend)\n  \n  homegood_dig_spend <- rbind(homegood_dig_spend,data_spend)\n  \n  homegood_dcm_dc_loop <- NULL\n  \n  data <- NULL\n  \n  data_spend <- NULL\n  \n}\n\n\nwrite.csv(homegood_dig_spend, file = \"DIG/homegood_DIG_Spend.csv\", row.names = FALSE)\n\nwrite.xlsx(homegood_dig_spend, file = \"DIG/homegood_DIG_Spend.xlsx\", row.names = FALSE)\n",
    "created" : 1510529166181.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3933857813",
    "id" : "2B52E4F",
    "lastKnownWriteTime" : 1510590475,
    "last_content_update" : 1510590475619,
    "path" : "~/Python Scripts/R_double_click/script/homegoods_spend.R",
    "project_path" : "script/homegoods_spend.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}